name: Build Android APK

# Trigger the workflow on push to main branch and pull requests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v4

    # Set up Java Development Kit
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 8512546

    # Verify and fix gradlew
    - name: Check and prepare gradlew
      run: |
        cd android_stuff
        echo "Checking gradlew file..."
        ls -la gradlew
        echo "Converting line endings to Unix format..."
        dos2unix gradlew 2>/dev/null || sed -i 's/\r$//' gradlew
        echo "Making gradlew executable..."
        chmod +x gradlew
        echo "Verifying gradlew permissions..."
        ls -la gradlew
        echo "Checking gradlew file type..."
        file gradlew
        echo "Testing gradlew execution..."
        ./gradlew --version

    # Clean previous builds
    - name: Clean project
      run: |
        cd android_stuff
        ./gradlew clean --stacktrace

    # Build debug APK
    - name: Build Debug APK
      run: |
        cd android_stuff
        ./gradlew assembleDebug --stacktrace

    # Build release APK
    - name: Build Release APK
      run: |
        cd android_stuff
        ./gradlew assembleRelease --stacktrace

    # Upload Debug APK as artifact
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: tetris-game-debug-apk
        path: android_stuff/app/build/outputs/apk/debug/*.apk
        retention-days: 30

    # Upload Release APK as artifact
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: tetris-game-release-apk
        path: android_stuff/app/build/outputs/apk/release/*.apk
        retention-days: 30

    # Create a release (optional - only on main branch)
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Tetris Game Release v${{ github.run_number }}
        body: |
          ðŸŽ® **VISWA'S CREATION - Tetris Game**
          
          This release contains the latest build of the Tetris game with:
          - Classic Tetris gameplay
          - Touch controls
          - Professional splash screen with animations
          - Scoring system
          
          **Installation:**
          1. Download the APK from the artifacts below
          2. Enable "Unknown Sources" in your Android device settings
          3. Install the APK
          4. Enjoy the game!
          
          **Requirements:**
          - Android 5.0 (API 21) or higher
        files: |
          android_stuff/app/build/outputs/apk/debug/*.apk
          android_stuff/app/build/outputs/apk/release/*.apk
        draft: false
        prerelease: false 